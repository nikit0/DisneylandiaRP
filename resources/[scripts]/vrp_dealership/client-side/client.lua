-----------------------------------------------------------------------------------------------------------------------------------------
-- VRP
-----------------------------------------------------------------------------------------------------------------------------------------
local Tunnel = module("vrp", "lib/Tunnel")
local Proxy = module("vrp", "lib/Proxy")
vRP = Proxy.getInterface("vRP")
-----------------------------------------------------------------------------------------------------------------------------------------
-- CONEXÃO
-----------------------------------------------------------------------------------------------------------------------------------------
src = {}
Tunnel.bindInterface("vrp_dealership", src)
vSERVER = Tunnel.getInterface("vrp_dealership")
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIÁVEIS
-----------------------------------------------------------------------------------------------------------------------------------------
local dealerOpen = false
-----------------------------------------------------------------------------------------------------------------------------------------
-- DEALERS
-----------------------------------------------------------------------------------------------------------------------------------------
local dealers = {
	{ ['x'] = -788.76, ['y'] = -216.45, ['z'] = 37.08, ['h'] = 128.96 },
	{ ['x'] = -791.42, ['y'] = -218.18, ['z'] = 37.08, ['h'] = 297.03 },
	{ ['x'] = -307.19, ['y'] = 6126.09, ['z'] = 31.5, ['h'] = 357.14 },
	{ ['x'] = -794.77, ['y'] = -221.27, ['z'] = 37.08, ['h'] = 299.09 }
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- OPEN DEALER
-----------------------------------------------------------------------------------------------------------------------------------------
CreateThread(function()
	while true do
		local idle = 500
		local ped = PlayerPedId()
		if not IsPedInAnyVehicle(ped) then
			local x, y, z = table.unpack(GetEntityCoords(ped))
			for k, v in pairs(dealers) do
				local distance = Vdist(x, y, z, v.x, v.y, v.z)
				if distance <= 10.5 then
					idle = 5
					DrawMarker(21, v.x, v.y, v.z - 0.6, 0, 0, 0, 0.0, 0, 0, 0.5, 0.5, 0.4, 255, 0, 0, 50, 0, 0, 0, 1)
					if distance <= 1.5 and IsControlJustPressed(0, 38) and vSERVER.getPermission() and IsInputDisabled(0) then
						vSERVER.updateVehicles()
						SetNuiFocus(true, true)
						SendNUIMessage({ action = "showMenu" })
						dealerOpen = true
						vRP._playAnim(false, { "anim@heists@prison_heistig1_p1_guard_checks_bus", "loop" }, true)
						SetEntityHeading(ped, v.h)
					end
				end
			end
		end
		Wait(idle)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- STARTFOCUS
-----------------------------------------------------------------------------------------------------------------------------------------
CreateThread(function()
	SetNuiFocus(false, false)
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- DEALERCLOSE
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("dealerClose", function(data)
	SetNuiFocus(false, false)
	SendNUIMessage({ action = "hideMenu" })
	dealerOpen = false
	vRP._stopAnim(false)
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- REQUESTCARROS
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("requestCarros", function(data, cb)
	local veiculos = vSERVER.Carros()
	if veiculos then
		cb({ veiculos = veiculos, perm = vSERVER.checkPermission() })
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- REQUESTMOTOS
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("requestMotos", function(data, cb)
	local veiculos = vSERVER.Motos()
	if veiculos then
		cb({ veiculos = veiculos, perm = vSERVER.checkPermission() })
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- REQUESTIMPORT
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("requestImport", function(data, cb)
	local veiculos = vSERVER.Import()
	if veiculos then
		cb({ veiculos = veiculos, perm = vSERVER.checkPermission() })
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- REQUESTPOSSUIDOS
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("requestPossuidos", function(data, cb)
	local veiculos = vSERVER.Possuidos()
	if veiculos then
		cb({ veiculos = veiculos, perm = vSERVER.checkPermission() })
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- BUYDEALER
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("buyDealer", function(data)
	if data.name ~= nil then
		vSERVER.buyDealer(data.name)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- SELLDEALER
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("sellDealer", function(data)
	if data.name ~= nil then
		vSERVER.sellDealer(data.name)
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- AUTO-UPDATE
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("dealership:Update")
AddEventHandler("dealership:Update", function(action)
	SendNUIMessage({ action = action })
end)
-----------------------------------------------------------------------------------------------------------------------------------------
--
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("dealership:Close")
AddEventHandler("dealership:Close", function()
	SetNuiFocus(false, false)
	SendNUIMessage({ action = "hideMenu" })
	dealerOpen = false
	vRP._DeletarObjeto()
end)
